<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dottie's Milltown Frolic!</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:#0d0d1f;display:flex;flex-direction:column;
  align-items:center;justify-content:center;min-height:100vh;
  font-family:'Press Start 2P',monospace;overflow:hidden;
}
#wrap{position:relative;border:4px solid #ffe000;box-shadow:0 0 40px #ffe000aa,0 0 80px #ff8c0055;}
canvas{display:block;}
#hud{
  background:#050510;border-top:3px solid #ffe000;padding:5px 12px;
  display:flex;justify-content:space-between;align-items:center;
  width:100%;color:#ffe000;font-size:7px;gap:6px;
}
.hi{display:flex;flex-direction:column;align-items:center;gap:1px;}
.hl{color:#666;font-size:5px;}.hv{color:#fff;font-size:8px;}.hv.y{color:#ffe000;}
#loading{
  position:absolute;top:0;left:0;right:0;bottom:40px;
  background:#0d0d1f;display:flex;flex-direction:column;
  align-items:center;justify-content:center;color:#ffe000;gap:16px;z-index:20;
}
#loadMsg{font-size:8px;color:#aaa;}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c" width="800" height="560"></canvas>
  <div id="hud">
    <div class="hi"><span class="hl">SCORE</span><span class="hv y" id="hS">0</span></div>
    <div class="hi"><span class="hl">BEST</span><span class="hv" id="hB">0</span></div>
    <div class="hi"><span class="hl">LIVES</span><span class="hv" id="hL">â¤ï¸â¤ï¸â¤ï¸</span></div>
    <div class="hi"><span class="hl">LEVEL</span><span class="hv y" id="hLv">1</span></div>
    <div class="hi"><span class="hl">BOOST</span><span class="hv" id="hBo">READY</span></div>
    <canvas id="mm" width="88" height="72" style="border:1px solid #333;"></canvas>
  </div>
  <div id="loading">
    <div style="font-size:14px;color:#ffe000;">ğŸ¾ DOTTIE'S MILLTOWN FROLIC</div>
    <p id="loadMsg">Loading Milltown map...</p>
  </div>
</div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOTTIE'S MILLTOWN FROLIC  v7
//  â€¢ Real OSM map tiles â€” CORRECT tile grid covering actual Milltown
//  â€¢ Shadow bug fixed: resetCtx() wipes ALL canvas state each frame
//  Â© OpenStreetMap contributors
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const C  = document.getElementById('c');
const cx = C.getContext('2d');
const MM = document.getElementById('mm');
const mx = MM.getContext('2d');
const VW=800, VH=560;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// THE FIX: Call resetCtx() at the TOP of every render frame.
// Canvas state (shadowBlur, lineWidth, globalAlpha, etc.) is
// cumulative â€” it NEVER resets between frames on its own.
// shadowBlur set during title/gameover text bleeds into road
// polylines on the very next frame, causing the "triangle" glow.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetCtx(ctx) {
  ctx.shadowBlur    = 0;
  ctx.shadowColor   = 'transparent';
  ctx.globalAlpha   = 1;
  ctx.globalCompositeOperation = 'source-over';
  ctx.lineWidth     = 1;
  ctx.lineCap       = 'butt';
  ctx.lineJoin      = 'miter';
  ctx.setLineDash([]);
  ctx.lineDashOffset= 0;
  ctx.font          = '10px sans-serif';
  ctx.textAlign     = 'left';
  ctx.textBaseline  = 'alphabetic';
  ctx.fillStyle     = '#000';
  ctx.strokeStyle   = '#000';
}

// â”€â”€ World size & geo projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// We stitch 4Ã—4 OSM tiles at zoom 16 to cover Milltown.
// Tile coords for Milltown NJ center â‰ˆ lat 40.454, lon -74.443
// At zoom 16: tile x=19647, y=24067
// We'll load a 2Ã—3 grid of tiles (each 256px) â†’ 512Ã—768 source
// then scale+offset to fill our 1600Ã—1300 world

const WW = 1600, WH = 1300;

// â”€â”€ Verified tile grid for Milltown NJ (zoom 16) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// v6 was wrong â€” it covered North Brunswick instead of Milltown.
// These constants were computed by checking every landmark GPS
// coordinate against tile boundaries until all fit with margin.
const ZOOM = 16;

// Correct 6Ã—6 tile grid (36 tiles total)
const TX0 = 19214, TY0 = 24699;
const TX1 = 19219, TY1 = 24704;

// Pre-computed geo extent of this exact tile grid
// (verified: all 13 landmarks fall comfortably inside)
const GEO = {
  n:  40.467845,
  s:  40.442767,
  w: -74.454346,
  e: -74.421387
};

function geoToWorld(lat, lon) {
  const x = ((lon - GEO.w) / (GEO.e - GEO.w)) * WW;
  const y = ((GEO.n - lat) / (GEO.n - GEO.s)) * WH;
  return [x, y];
}

// â”€â”€ Map tile canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// We pre-render all tiles onto an offscreen canvas (mapCanvas)
// then drawImage it each frame â€” fast and no per-frame tile fetching
const mapCanvas = document.createElement('canvas');
mapCanvas.width  = WW;
mapCanvas.height = WH;
const mapCtx = mapCanvas.getContext('2d');
let mapLoaded = false;

async function loadMapTiles() {
  const msg = document.getElementById('loadMsg');
  const TILE_SIZE = 256;
  const COLS = TX1 - TX0 + 1; // 6
  const ROWS = TY1 - TY0 + 1; // 6
  const srcW = COLS * TILE_SIZE; // 1536
  const srcH = ROWS * TILE_SIZE; // 1536

  // Offscreen for raw tiles
  const tileCanvas = document.createElement('canvas');
  tileCanvas.width  = srcW;
  tileCanvas.height = srcH;
  const tCtx = tileCanvas.getContext('2d');

  let loaded = 0;
  const total = COLS * ROWS;
  const promises = [];

  for (let row = 0; row < ROWS; row++) {
    for (let col = 0; col < COLS; col++) {
      const tx = TX0 + col;
      const ty = TY0 + row;
      // Use tile.openstreetmap.org â€” free, no API key needed
      const url = `https://tile.openstreetmap.org/${ZOOM}/${tx}/${ty}.png`;
      promises.push(
        new Promise((res) => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => {
            tCtx.drawImage(img, col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            loaded++;
            msg.textContent = `Loading map tilesâ€¦ ${loaded}/${total}`;
            res();
          };
          img.onerror = () => {
            // Fill missing tile with a grass color
            tCtx.fillStyle = '#a8c880';
            tCtx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            loaded++;
            res();
          };
          img.src = url;
        })
      );
    }
  }

  await Promise.all(promises);

  // Scale/stretch tile composite onto our WWÃ—WH world canvas
  // Slight NES-style saturation boost
  mapCtx.filter = 'saturate(1.3) contrast(1.05)';
  mapCtx.drawImage(tileCanvas, 0, 0, WW, WH);
  mapCtx.filter = 'none';

  mapLoaded = true;
  document.getElementById('loading').style.display = 'none';
}

// â”€â”€ High scores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadHS(){try{return JSON.parse(localStorage.getItem('dottieHS7')||'[]');}catch{return[];}}
function saveHS(s){let a=loadHS();a.push(s);a.sort((a,b)=>b-a);a=a.slice(0,5);try{localStorage.setItem('dottieHS7',JSON.stringify(a));}catch{}return a;}

// â”€â”€ Game state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let STATE='loading';
let score=0,lives=3,level=1,gframe=0,titleF=0;
let shX=0,shY=0,shT=0;
let particles=[];
let HS=loadHS();

// â”€â”€ Camera (integer snap â€” no lerp = no jitter) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cam={x:0,y:0};
function snapCam(tx,ty){
  cam.x=Math.round(Math.max(0,Math.min(WW-VW,tx-VW/2)));
  cam.y=Math.round(Math.max(0,Math.min(WH-VH,ty-VH/2)));
}

// Shake is added INTO the coordinate functions â€” no ctx.translate
function sx(v){return Math.round(v - cam.x + shX);}
function sy(v){return Math.round(v - cam.y + shY);}
function pr(x,y,w,h,c){cx.fillStyle=c;cx.fillRect(x,y,w,h);}

// â”€â”€ Landmarks (real GPS coordinates) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LM_DEF = [
  {n:"MARIA'S\nPIZZA",      lat:40.4585, lon:-74.4412, w:90, h:66, c:'#CC2222', food:'ğŸ•', pts:25},
  {n:"ICE CREAM\nDEPOT",    lat:40.4535, lon:-74.4414, w:90, h:64, c:'#FF88BB', food:'ğŸ¦', pts:20},
  {n:"FOUR BOYS\nICE CREAM", lat:40.4527, lon:-74.4387, w:98, h:64, c:'#2244CC', food:'ğŸ¦', pts:20},
  {n:"BOROUGH\nHALL",        lat:40.4527, lon:-74.4438, w:86, h:64, c:'#998866', food:'ğŸ›ï¸', pts:5},
  {n:"LIBRARY",              lat:40.4557, lon:-74.4432, w:82, h:60, c:'#775533', food:'ğŸ“š', pts:10},
  {n:"KILMER\nSCHOOL",       lat:40.4560, lon:-74.4431, w:88, h:64, c:'#886600', food:'ğŸ’', pts:10},
  {n:"HOME\n141 Albert",     lat:40.4513, lon:-74.4462, w:70, h:56, c:'#A04820', food:'ğŸ¦´', pts:5},
  {n:"BESTIE'S\nHOUSE",      lat:40.4590, lon:-74.4230, w:80, h:60, c:'#BB44AA', food:'ğŸª', pts:15},
  {n:"MILLTOWN\nCONV.",       lat:40.4555, lon:-74.4362, w:88, h:58, c:'#337744', food:'ğŸ¥¤', pts:15},
  {n:"MILLTOWN\nDINER",       lat:40.4522, lon:-74.4272, w:90, h:62, c:'#CC9922', food:'ğŸ¥', pts:20},
  {n:"FIRE HOUSE",            lat:40.4512, lon:-74.4250, w:82, h:58, c:'#CC3300', food:'ğŸš’', pts:5},
  {n:"BORO PARK",             lat:40.4600, lon:-74.4478, w:140,h:120,c:'#2EAA44', food:'ğŸŒ³', pts:10, park:true},
  {n:"ALBERT AVE\nPARK",      lat:40.4512, lon:-74.4478, w:90, h:80, c:'#3BAA33', food:'âš½', pts:10, park:true},
];

let LM = [];
function initLandmarks(){
  LM = LM_DEF.map(d=>{
    const [wx,wy] = geoToWorld(d.lat, d.lon);
    return {...d, wx:wx-d.w/2, wy:wy-d.h/2};
  });
}

// â”€â”€ Title screen stars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const stars=Array.from({length:70},()=>({
  x:Math.random()*VW, y:Math.random()*VH,
  sz:Math.random()*1.8+0.4, spd:Math.random()*0.22+0.07,
  tw:Math.random()*Math.PI*2
}));
let titleDX=VW+80, titleDDir=-1;

// â”€â”€ Dottie â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DOT={wx:400,wy:700,dir:1,spd:2.8,boosting:false,bTimer:0,bCool:0};

// â”€â”€ Parents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PARENTS=[
  {wx:600,wy:300,spd:1.1,col:'#3355CC',trim:'#7799FF',name:'MOM',fr:0,wa:0},
  {wx:1200,wy:800,spd:1.0,col:'#CC3333',trim:'#FF8866',name:'DAD',fr:0,wa:Math.PI},
];

// â”€â”€ Food & bones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let FOOD=[], BONES=[];
function spawnAll(){
  FOOD=[];
  LM.forEach(lm=>{
    for(let i=0;i<(lm.park?3:2);i++){
      FOOD.push({
        wx:lm.wx+14+Math.random()*(lm.w-28),
        wy:lm.wy+14+Math.random()*(lm.h-28),
        emoji:lm.food, pts:lm.pts, lm,
        bob:Math.random()*Math.PI*2, col:false, respawn:0
      });
    }
  });
  BONES=[];
  for(let i=0;i<10;i++)
    BONES.push({wx:80+Math.random()*(WW-160), wy:80+Math.random()*(WH-160), col:false, respawn:0});
}

// â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const K={};
window.addEventListener('keydown',e=>{
  K[e.code]=true;
  if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault();
});
window.addEventListener('keyup',e=>{K[e.code]=false;});

// â”€â”€ Particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addP(wx2,wy2,txt,col,big){
  particles.push({wx:wx2,wy:wy2,txt,col,life:90,max:90,vy:-1.0,big:!!big});
}

// â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetGame(){
  const home=LM.find(l=>l.n.startsWith('HOME'));
  score=0;lives=3;level=1;gframe=0;shX=0;shY=0;shT=0;
  DOT.wx=home?home.wx+home.w/2:400;
  DOT.wy=home?home.wy+home.h/2:700;
  DOT.dir=1;DOT.boosting=false;DOT.bTimer=0;DOT.bCool=0;
  PARENTS[0].wx=600;PARENTS[0].wy=300;PARENTS[0].spd=1.1;
  PARENTS[1].wx=1200;PARENTS[1].wy=800;PARENTS[1].spd=1.0;
  particles=[];
  spawnAll();
  STATE='playing';
}

function pSpeed(b){return Math.min(b+(level-1)*0.15,2.5);}
function lvlThresh(){return level*160;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function update(){
  titleF++;
  if(STATE==='loading'||STATE==='paused') return;
  if(STATE==='title'){
    titleDX += 2.5*titleDDir;
    if(titleDX > VW+100){titleDX=VW+100; titleDDir=-1;}
    if(titleDX < -100){titleDX=-100; titleDDir=1;}
    return;
  }
  if(STATE!=='playing') return;
  gframe++;

  // Movement
  const spd=DOT.boosting?DOT.spd*2.4:DOT.spd;
  let dx=0,dy=0;
  if(K['ArrowLeft']||K['KeyA']){dx=-spd;DOT.dir=-1;}
  if(K['ArrowRight']||K['KeyD']){dx= spd;DOT.dir= 1;}
  if(K['ArrowUp']  ||K['KeyW']) dy=-spd;
  if(K['ArrowDown']||K['KeyS']) dy= spd;
  if(dx&&dy){dx*=0.707;dy*=0.707;}
  DOT.wx=Math.max(16,Math.min(WW-16,DOT.wx+dx));
  DOT.wy=Math.max(16,Math.min(WH-16,DOT.wy+dy));

  // Boost
  if(DOT.bCool>0) DOT.bCool--;
  if(DOT.boosting){DOT.bTimer--;if(DOT.bTimer<=0)DOT.boosting=false;}
  if(K['Space']&&DOT.bCool===0&&!DOT.boosting){
    DOT.boosting=true;DOT.bTimer=100;DOT.bCool=360;
    addP(DOT.wx,DOT.wy-20,'ğŸ’¨ ZOOM!','#FFD700',true);
  }

  snapCam(DOT.wx,DOT.wy);

  // Food
  FOOD.forEach(f=>{
    if(f.col){
      if(gframe>=f.respawn){f.col=false;f.wx=f.lm.wx+14+Math.random()*(f.lm.w-28);f.wy=f.lm.wy+14+Math.random()*(f.lm.h-28);}
      return;
    }
    f.bob+=0.05;
    if(Math.hypot(DOT.wx-f.wx,DOT.wy-f.wy)<22){
      f.col=true;f.respawn=gframe+300;score+=f.pts;
      addP(f.wx,f.wy-10,'+'+f.pts+' '+f.emoji,'#FFD700');
      if(score>=lvlThresh()){level++;addP(DOT.wx,DOT.wy-40,'â­ LEVEL '+level+'!','#FFD700',true);shT=20;}
    }
  });

  // Bones
  BONES.forEach(b=>{
    if(b.col){
      if(gframe>=b.respawn){b.col=false;b.wx=80+Math.random()*(WW-160);b.wy=80+Math.random()*(WH-160);}
      return;
    }
    if(Math.hypot(DOT.wx-b.wx,DOT.wy-b.wy)<22){
      b.col=true;b.respawn=gframe+500;DOT.bCool=0;
      addP(b.wx,b.wy-10,'ğŸ¦´ ZOOM READY!','#fff',true);
    }
  });

  // Parents
  PARENTS.forEach(p=>{
    p.fr++;p.wa+=0.016;
    const ps=pSpeed(p.spd);
    const dist=Math.hypot(DOT.wx-p.wx,DOT.wy-p.wy);
    const detect=260+level*25;
    const angle=dist<detect
      ? Math.atan2(DOT.wy-p.wy,DOT.wx-p.wx)+(Math.random()-.5)*0.18
      : p.wa;
    p.wx=Math.max(16,Math.min(WW-16,p.wx+Math.cos(angle)*ps));
    p.wy=Math.max(16,Math.min(WH-16,p.wy+Math.sin(angle)*ps));
    if(dist<26){
      lives--;shT=40;
      addP(DOT.wx,DOT.wy-30,'CAUGHT! ğŸ’”','#ff4444',true);
      const home=LM.find(l=>l.n.startsWith('HOME'));
      DOT.wx=home?home.wx+home.w/2:400;
      DOT.wy=home?home.wy+home.h/2:700;
      p.wx=700+Math.random()*300;p.wy=200+Math.random()*400;
      if(lives<=0){HS=saveHS(score);STATE='gameover';}
    }
  });

  // Shake decay
  if(shT>0){shT--;shX=(Math.random()-.5)*6;shY=(Math.random()-.5)*6;}else{shX=0;shY=0;}

  // Particles
  particles.forEach(p=>{p.wy+=p.vy;p.life--;});
  particles=particles.filter(p=>p.life>0);

  // HUD
  document.getElementById('hS').textContent=score;
  document.getElementById('hB').textContent=HS[0]||0;
  document.getElementById('hL').textContent='â¤ï¸'.repeat(Math.max(0,lives));
  document.getElementById('hLv').textContent=level;
  const bc=DOT.bCool;
  document.getElementById('hBo').textContent=DOT.boosting?'ZOOMING!':bc>0?Math.ceil(bc/60)+'s':'READY';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIXEL SPRITE: DOTTIE
//  - No ctx.scale() for mirroring (was causing triangle artifacts)
//  - No cx.ellipse() for shadow (was accumulating path state)
//  - Shadow is a simple semi-transparent rect
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawDot(wx2,wy2,dir,fr,alpha){
  const s=2;
  const px0=sx(wx2)-16, py0=sy(wy2)-22;
  const leg=Math.sin(fr*0.32)>0;
  const m=(x,w)=>dir===1 ? px0+x*s : px0+(24-x-w)*s; // manual mirror, no ctx transform
  const py=(y)=>py0+y*s;

  if(alpha!==undefined) cx.globalAlpha=alpha;

  // Ground shadow: rect only, no ellipse, no beginPath needed
  pr(px0+4, py0+28, 24, 5, 'rgba(0,0,0,0.18)');

  // Tail
  pr(m(0,2),   py(5),  2*s,   s, '#C49040');
  // Body
  pr(m(2,10),  py(5),  10*s, 6*s,'#D4A855');
  // Belly
  pr(m(3,7),   py(7),  7*s,  4*s,'#E8C98A');
  // Red collar
  pr(m(3,8),   py(5),  8*s,    s, '#CC2200');
  // Gold tag
  pr(m(6,2),   py(6),  2*s,  2*s,'#FFD700');
  // Legs (animated)
  pr(m(3,2),   py(10), 2*s, (leg?4:3)*s,'#C49040');
  pr(m(7,2),   py(10), 2*s, (leg?3:4)*s,'#C49040');
  pr(m(11,2),  py(10), 2*s, (leg?4:3)*s,'#C49040');
  // Head
  pr(m(10,7),  py(0),  7*s,  6*s,'#D4A855');
  // Muzzle
  pr(m(11,5),  py(3),  5*s,  4*s,'#E8C98A');
  // Nose
  pr(m(12,3),  py(3),  3*s,    s, '#5a2d0c');
  // Eye
  pr(m(14,1),  py(1),    s,    s, '#8B5E3C');
  // Ear
  pr(m(10,3),  py(-2), 3*s,  3*s,'#C49040');
  pr(m(10,2),  py(0),  2*s,  3*s,'#B07830');

  cx.globalAlpha=1;
}

// â”€â”€ Parent sprite â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawParent(p){
  const s=2;
  const px0=sx(p.wx)-14, py0=sy(p.wy)-28;
  const leg=Math.sin(p.fr*0.28)>0;

  // Shadow: rect, not ellipse
  pr(px0+2, py0+52, 24, 5, 'rgba(0,0,0,0.16)');

  // Legs
  pr(px0+2*s, py0+9*s, 2*s, (leg?5:3)*s,'#223355');
  pr(px0+5*s, py0+9*s, 2*s, (leg?3:5)*s,'#223355');
  // Body
  pr(px0+s,   py0+4*s, 7*s, 5*s, p.col);
  pr(px0,     py0+4*s,   s, 4*s, p.trim);
  pr(px0+8*s, py0+4*s,   s, 4*s, p.trim);
  // Head
  pr(px0+2*s, py0,     5*s, 4*s,'#FDBCB4');
  pr(px0+2*s, py0,     5*s,   s, '#3a1e00');
  // Eyes
  pr(px0+3*s, py0+2*s,   s,   s,'#222');
  pr(px0+5*s, py0+2*s,   s,   s,'#222');

  // Name tag (dark background behind text so it reads cleanly)
  pr(px0-2, py0-14, 32, 10, 'rgba(0,0,0,0.75)');
  cx.fillStyle=p.col;
  cx.font='6px "Press Start 2P"';
  cx.textAlign='center';
  cx.fillText(p.name, px0+14, py0-6);
}

// â”€â”€ Map background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMapBg(){
  if(!mapLoaded) return;
  // Shake offset built into sx()/sy() â€” drawImage needs manual offset
  cx.drawImage(mapCanvas,
    cam.x - shX, cam.y - shY, VW, VH,  // source rect (with shake inverse)
    0,           0,            VW, VH); // dest fills viewport
}

// â”€â”€ Landmark overlays on top of real map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawLandmarks(){
  LM.forEach(lm=>{
    const lx=sx(lm.wx), ly=sy(lm.wy);
    if(lx+lm.w<0||lx>VW||ly+lm.h<0||ly>VH) return;

    if(lm.park){
      // Translucent green overlay on park areas
      cx.fillStyle='rgba(46,170,68,0.35)';
      cx.fillRect(lx,ly,lm.w,lm.h);
      cx.strokeStyle='#1A7030';cx.lineWidth=2;
      cx.strokeRect(lx,ly,lm.w,lm.h);
    } else {
      // Semi-transparent building overlay so real map shows through
      cx.fillStyle='rgba(0,0,0,0.25)';cx.fillRect(lx+3,ly+4,lm.w,lm.h); // shadow
      cx.fillStyle=lm.c+'cc'; // 80% opacity
      cx.fillRect(lx,ly,lm.w,lm.h);
      cx.fillStyle='rgba(0,0,0,0.3)';cx.fillRect(lx,ly,lm.w,7);
      cx.fillStyle='#2A1200';cx.fillRect(lx+lm.w/2-5,ly+lm.h-18,10,18); // door
      cx.fillStyle='rgba(170,221,255,0.8)';cx.fillRect(lx+7,ly+12,12,10); // window
      if(lm.w>75) cx.fillRect(lx+lm.w-19,ly+12,12,10);
    }

    // Label
    const lines=lm.n.split('\n');
    const textY=ly+lm.h/2-(lines.length-1)*5;
    cx.font='5px "Press Start 2P"';
    cx.textAlign='center';
    lines.forEach((ln,i)=>{
      cx.strokeStyle='rgba(0,0,0,0.95)';cx.lineWidth=3;
      cx.strokeText(ln, lx+lm.w/2, textY+i*10);
      cx.fillStyle='#fff';
      cx.fillText(ln, lx+lm.w/2, textY+i*10);
    });
  });
}

// â”€â”€ Food collectibles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawFood(){
  FOOD.forEach(f=>{
    if(f.col) return;
    const fx=sx(f.wx), fy=sy(f.wy);
    if(fx<-20||fx>VW+20||fy<-20||fy>VH+20) return;
    const b=Math.sin(f.bob)*3;
    cx.font='15px serif'; cx.textAlign='center';
    cx.fillText(f.emoji, fx, fy+b);
    if(gframe%28<14){
      cx.fillStyle='#FFD700';
      cx.font='7px serif';
      cx.fillText('âœ¦', fx+10, fy+b-8);
    }
  });
  BONES.forEach(b=>{
    if(b.col) return;
    const bx=sx(b.wx), by=sy(b.wy);
    if(bx<-20||bx>VW+20||by<-20||by>VH+20) return;
    cx.font='15px serif'; cx.textAlign='center';
    cx.fillText('ğŸ¦´', bx, by+Math.sin(gframe*0.07)*3);
  });
}

// â”€â”€ Particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawParticles(){
  particles.forEach(p=>{
    const px2=sx(p.wx), py2=sy(p.wy);
    cx.globalAlpha=p.life/p.max;
    cx.font=(p.big?'8':'6')+'px "Press Start 2P"';
    cx.textAlign='center';
    cx.strokeStyle='rgba(0,0,0,0.9)'; cx.lineWidth=2;
    cx.strokeText(p.txt, px2, py2);
    cx.fillStyle=p.col;
    cx.fillText(p.txt, px2, py2);
  });
  cx.globalAlpha=1;
}

// â”€â”€ Minimap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMinimap(){
  const mw=MM.width, mh=MM.height;
  mx.clearRect(0,0,mw,mh);
  // Scaled map tile
  if(mapLoaded) mx.drawImage(mapCanvas, 0, 0, WW, WH, 0, 0, mw, mh);
  else {mx.fillStyle='#2a4a10';mx.fillRect(0,0,mw,mh);}
  const scx=mw/WW, scy=mh/WH;
  // Camera box
  mx.strokeStyle='rgba(255,220,0,0.9)'; mx.lineWidth=1.5;
  mx.strokeRect(cam.x*scx, cam.y*scy, VW*scx, VH*scy);
  // Dottie dot
  mx.fillStyle='#FFD700';
  mx.fillRect(DOT.wx*scx-2, DOT.wy*scy-2, 5, 5);
  // Parent dots
  PARENTS.forEach(p=>{
    mx.fillStyle=p.col;
    mx.fillRect(p.wx*scx-2, p.wy*scy-2, 4, 4);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TITLE SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BLDGS=[
  {x:30,w:85,h:130},{x:130,w:60,h:110},{x:210,w:100,h:165},
  {x:330,w:70,h:120},{x:420,w:90,h:180},{x:530,w:65,h:115},
  {x:620,w:110,h:155},{x:575,w:50,h:88}
];

function drawTitleDottie(dsx,dsy,dir,fr){
  const s=3, px0=dsx-16, py0=dsy-22;
  const leg=Math.sin(fr*0.32)>0;
  const m=(x,w)=>dir===1?px0+x*s:px0+(24-x-w)*s;
  const py=(y)=>py0+y*s;
  pr(px0+4,py0+32,30,7,'rgba(0,0,0,0.2)');
  pr(m(0,2),py(5),2*s,s,'#C49040');
  pr(m(2,10),py(5),10*s,6*s,'#D4A855');
  pr(m(3,7),py(7),7*s,4*s,'#E8C98A');
  pr(m(3,8),py(5),8*s,s,'#CC2200');
  pr(m(6,2),py(6),2*s,2*s,'#FFD700');
  pr(m(3,2),py(10),2*s,(leg?4:3)*s,'#C49040');
  pr(m(7,2),py(10),2*s,(leg?3:4)*s,'#C49040');
  pr(m(11,2),py(10),2*s,(leg?4:3)*s,'#C49040');
  pr(m(10,7),py(0),7*s,6*s,'#D4A855');
  pr(m(11,5),py(3),5*s,4*s,'#E8C98A');
  pr(m(12,3),py(3),3*s,s,'#5a2d0c');
  pr(m(14,1),py(1),s,s,'#8B5E3C');
  pr(m(10,3),py(-2),3*s,3*s,'#C49040');
  pr(m(10,2),py(0),2*s,3*s,'#B07830');
}

function drawTitle(){
  // Sky
  const sky=cx.createLinearGradient(0,0,0,VH);
  sky.addColorStop(0,'#040818'); sky.addColorStop(1,'#0a1835');
  cx.fillStyle=sky; cx.fillRect(0,0,VW,VH);
  // Stars
  stars.forEach(s=>{
    s.tw+=0.035; s.y+=s.spd; if(s.y>VH) s.y=0;
    cx.fillStyle=`rgba(255,252,210,${0.35+Math.sin(s.tw)*0.4})`;
    cx.fillRect(s.x,s.y,s.sz,s.sz);
  });
  // Ground + road
  const g=cx.createLinearGradient(0,VH-130,0,VH);
  g.addColorStop(0,'#3d7020'); g.addColorStop(1,'#254012');
  cx.fillStyle=g; cx.fillRect(0,VH-130,VW,130);
  cx.fillStyle='#4a4840'; cx.fillRect(0,VH-86,VW,42);
  for(let x=titleF%56;x<VW;x+=56){cx.fillStyle='#F5E040';cx.fillRect(x,VH-66,28,4);}
  // Silhouette buildings
  BLDGS.forEach(b=>{
    cx.fillStyle='#12122a'; cx.fillRect(b.x,VH-130-b.h,b.w,b.h);
    for(let wy2=VH-130-b.h+8;wy2<VH-130-16;wy2+=18)
      for(let wx2=b.x+7;wx2<b.x+b.w-12;wx2+=15){
        const lit=Math.sin((wx2*0.3+wy2*0.2+titleF*0.015)*1.1)>0.15;
        cx.fillStyle=lit?'#FFD070':'#0a0a20'; cx.fillRect(wx2,wy2,9,11);
      }
  });
  // Dottie running across road (no shadow here)
  drawTitleDottie(titleDX, VH-80, titleDDir, titleF);

  // Title card
  const pw=Math.sin(titleF*0.04)*3;
  cx.fillStyle='rgba(4,4,18,0.92)';
  cx.fillRect(VW/2-265+pw/2,52-pw/2,530-pw,215+pw);
  cx.strokeStyle='#ffe000'; cx.lineWidth=4;
  cx.strokeRect(VW/2-265+pw/2,52-pw/2,530-pw,215+pw);

  // *** Shadow for glow text â€” wrapped so it never leaks ***
  cx.save();
  cx.shadowColor='#ff4400'; cx.shadowBlur=14;
  const hue=(titleF*1.8)%360;
  cx.fillStyle=`hsl(${hue},100%,62%)`; cx.font='30px "Press Start 2P"'; cx.textAlign='center';
  cx.fillText("DOTTIE'S",VW/2,100);
  cx.restore(); // â† shadow cleared HERE, cannot bleed out

  cx.fillStyle='#ffe000'; cx.font='20px "Press Start 2P"'; cx.textAlign='center';
  cx.fillText('MILLTOWN',VW/2,136);
  cx.fillStyle='#88ffcc'; cx.fillText('FROLIC!',VW/2,164);
  cx.fillStyle='#888'; cx.font='6px "Press Start 2P"';
  cx.fillText('â˜…  ESCAPE FROM 141 ALBERT AVE Â· MILLTOWN NJ  â˜…',VW/2,192);
  cx.fillText('Arrow Keys/WASD Â· Space = boost Â· P = pause',VW/2,210);
  if(Math.floor(titleF/28)%2===0){
    cx.fillStyle='#fff'; cx.font='10px "Press Start 2P"';
    cx.fillText('PRESS  SPACE  TO  START',VW/2,278);
  }
  // High scores box
  const hsy=308;
  cx.fillStyle='rgba(4,4,18,0.9)'; cx.fillRect(VW/2-170,hsy,340,182);
  cx.strokeStyle='#ffe000'; cx.lineWidth=2; cx.strokeRect(VW/2-170,hsy,340,182);
  cx.fillStyle='#FFD700'; cx.font='8px "Press Start 2P"';
  cx.fillText('ğŸ†  HIGH SCORES  ğŸ†',VW/2,hsy+22);
  const sc=loadHS();
  if(!sc.length){
    cx.fillStyle='#666'; cx.font='7px "Press Start 2P"'; cx.fillText('no scores yet!',VW/2,hsy+60);
  } else {
    ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4.','5.'].forEach((m,i)=>{
      if(!sc[i]) return;
      cx.fillStyle=['#FFD700','#C0C0C0','#CD7F32','#aaa','#888'][i];
      cx.font='7px "Press Start 2P"';
      cx.fillText(`${m}  ${sc[i]} pts`,VW/2,hsy+44+i*26);
    });
  }
}

// â”€â”€ Game Over â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGameOver(){
  cx.fillStyle='rgba(0,0,8,0.88)'; cx.fillRect(0,0,VW,VH);
  const bx=VW/2-225, by=VH/2-210;
  cx.fillStyle='rgba(4,4,20,0.97)'; cx.fillRect(bx,by,450,420);
  cx.strokeStyle='#ff4444'; cx.lineWidth=4; cx.strokeRect(bx,by,450,420);

  // *** Glow text in save/restore so shadow doesn't escape ***
  cx.save();
  cx.shadowColor='#ff0000'; cx.shadowBlur=12;
  cx.fillStyle='#ff5555'; cx.font='18px "Press Start 2P"'; cx.textAlign='center';
  cx.fillText('OH NO!',VW/2,by+44);
  cx.restore();

  cx.fillStyle='#ff8888'; cx.font='12px "Press Start 2P"'; cx.textAlign='center';
  cx.fillText('DOTTIE GOT CAUGHT!',VW/2,by+74);
  cx.fillStyle='#777'; cx.font='6px "Press Start 2P"';
  cx.fillText('back on the leash... ğŸ˜”',VW/2,by+98);
  cx.fillStyle='#FFD700'; cx.font='12px "Press Start 2P"';
  cx.fillText('SCORE: '+score,VW/2,by+128);
  cx.font='8px "Press Start 2P"'; cx.fillText('ğŸ† TOP SCORES',VW/2,by+158);
  ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4.','5.'].forEach((m,i)=>{
    if(!HS[i]) return;
    const isNew=i===0&&HS[i]===score;
    cx.fillStyle=isNew?'#FFD700':['#FFD700','#C0C0C0','#CD7F32','#aaa','#888'][i];
    cx.font='7px "Press Start 2P"';
    cx.fillText(`${isNew?'â˜…':m}  ${HS[i]} pts`,VW/2,by+184+i*22);
  });
  if(Math.floor(titleF/26)%2===0){
    cx.fillStyle='#fff'; cx.font='9px "Press Start 2P"';
    cx.fillText('SPACE TO PLAY AGAIN',VW/2,by+300);
  }
  cx.fillStyle='#555'; cx.font='6px "Press Start 2P"';
  cx.fillText('ğŸ¾  good girl, dottie  ğŸ¾',VW/2,by+330);
}

function drawPause(){
  cx.fillStyle='rgba(0,0,8,0.72)'; cx.fillRect(0,0,VW,VH);
  cx.fillStyle='#ffe000'; cx.font='22px "Press Start 2P"'; cx.textAlign='center';
  cx.fillText('PAUSED',VW/2,VH/2-16);
  cx.fillStyle='#aaa'; cx.font='8px "Press Start 2P"';
  cx.fillText('P or ESC to resume',VW/2,VH/2+20);
}

// â”€â”€ Key bindings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('keydown',e=>{
  if(e.code==='Space'){
    if(STATE==='title')    resetGame();
    if(STATE==='gameover') resetGame();
  }
  if(e.code==='Escape'||e.code==='KeyP'){
    if(STATE==='playing') STATE='paused';
    else if(STATE==='paused') STATE='playing';
  }
},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
//  resetCtx() is called at the TOP of every frame.
//  This is the definitive fix â€” no canvas state from the previous
//  frame (shadowBlur, lineWidth, etc.) can ever bleed through.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  if(STATE==='loading') return;

  // *** THE FIX: hard-reset all canvas state before drawing anything ***
  resetCtx(cx);
  cx.clearRect(0,0,VW,VH);

  if(STATE==='title'){
    drawTitle();
    return;
  }

  if(STATE==='playing'||STATE==='paused'){
    // Real map tile as background
    drawMapBg();
    // Landmark overlays (semi-transparent so map shows through)
    drawLandmarks();
    // Food / bones
    drawFood();
    // Parents
    PARENTS.forEach(p=>drawParent(p));
    // Dottie afterimage when boosting
    if(DOT.boosting&&gframe%4<2)
      drawDot(DOT.wx-(DOT.dir*14), DOT.wy, DOT.dir, gframe, 0.3);
    // Dottie
    drawDot(DOT.wx, DOT.wy, DOT.dir, gframe);
    // Floating score text
    drawParticles();
    if(STATE==='paused') drawPause();
    // Minimap
    drawMinimap();
    // OSM credit (required by tile usage policy)
    cx.fillStyle='rgba(0,0,0,0.55)'; cx.fillRect(VW-182,VH-14,182,14);
    cx.fillStyle='rgba(255,255,255,0.75)'; cx.font='5px sans-serif'; cx.textAlign='right';
    cx.fillText('Â© OpenStreetMap contributors',VW-3,VH-4);
    return;
  }

  if(STATE==='gameover'){
    drawGameOver();
  }
}

// â”€â”€ Main loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop(){ update(); render(); requestAnimationFrame(loop); }

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initLandmarks();
// Reset Dottie to home position once landmarks are computed
(function(){
  const home=LM.find(l=>l.n.startsWith('HOME'));
  if(home){DOT.wx=home.wx+home.w/2; DOT.wy=home.wy+home.h/2;}
})();

loadMapTiles().then(()=>{
  STATE='title';
}).catch(()=>{
  document.getElementById('loadMsg').textContent='Map unavailable â€” playing anyway!';
  setTimeout(()=>{
    document.getElementById('loading').style.display='none';
    STATE='title';
  },1200);
});

loop();
</script>
</body>
</html>
